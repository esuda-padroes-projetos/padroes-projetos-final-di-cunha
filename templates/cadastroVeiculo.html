<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Cadastro de Ve√≠culo</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        select:disabled, input:disabled {
            background-color: #e9ecef;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <header><h1>Cadastrar Novo Ve√≠culo</h1></header>
    <div class="container">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <p class="{{ 'success' if category == 'success' else 'error' }}">{{ message }}</p>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <form action="{{ url_for('processar_cadastro_veiculo') }}" method="POST">
            
            <label for="cliente_id">Propriet√°rio:</label>
            <select name="cliente_id" id="cliente_id" required>
                <option value="" disabled selected>Selecione um cliente...</option>
                {% for cliente in clientes %}
                    <option value="{{ cliente[0] }}">{{ cliente[1] }} (CPF: {{ cliente[3] }})</option>
                {% endfor %}
            </select>

            <label for="tipo">Tipo de Ve√≠culo:</label>
            <select name="tipo" id="tipo" required>
                <option value="" disabled selected>-- Selecione o Tipo --</option>
                <option value="Carro">üöó Carro</option>
                <option value="Moto">üèçÔ∏è Moto</option>
                <option value="Caminh√£o">üöõ Caminh√£o</option>
            </select>

            <label for="marca">Marca:</label>
            <select name="marca" id="marca" required disabled>
                <option value="" disabled selected>Selecione o Tipo primeiro...</option>
            </select>
            <label for="modelo">Modelo:</label>
            <select name="modelo" id="modelo" required disabled>
                <option value="" disabled selected>Selecione a Marca primeiro...</option>
            </select>

            <label for="placa">Placa:</label>
            <input type="text" 
                   name="placa" 
                   id="placa" 
                   placeholder="ABC-1234" 
                   maxlength="8" 
                   required
                   oninput="mascaraPlaca(this)">

            <button type="submit">Cadastrar Ve√≠culo</button>
        </form>
        
        <a href="/landing" class="btn-voltar">Voltar ao Menu</a>
    </div>

    <script>
        function mascaraPlaca(i) {
            let v = i.value.toUpperCase().replace(/[^A-Z0-9]/g, "");
            if (v.length >= 3) v = v.replace(/^([A-Z]{3})([0-9A-Z]+)/, "$1-$2");
            i.value = v;
        }

        const selTipo = document.getElementById('tipo');
        const selMarca = document.getElementById('marca');
        const selModelo = document.getElementById('modelo');

        selTipo.addEventListener('change', async function() {
            const tipo = this.value;
            
            selMarca.innerHTML = '<option value="" disabled selected>Carregando...</option>';
            selModelo.innerHTML = '<option value="" disabled selected>Selecione a Marca primeiro...</option>';
            selModelo.disabled = true;

            try {
                const response = await fetch(`/api/dados-veiculos?tipo=${tipo}`);
                const marcas = await response.json();

                selMarca.innerHTML = '<option value="" disabled selected>-- Selecione a Marca --</option>';
                marcas.forEach(marca => {
                    const opt = document.createElement('option');
                    opt.value = marca;
                    opt.text = marca;
                    selMarca.appendChild(opt);
                });
                selMarca.disabled = false;
            } catch (err) {
                console.error(err);
                alert("Erro ao carregar marcas.");
            }
        });

        selMarca.addEventListener('change', async function() {
            const tipo = selTipo.value;
            const marca = this.value;

            selModelo.innerHTML = '<option value="" disabled selected>Carregando...</option>';
            selModelo.disabled = true;

            try {
                const response = await fetch(`/api/dados-veiculos?tipo=${tipo}&marca=${marca}`);
                const modelos = await response.json();

                selModelo.innerHTML = '<option value="" disabled selected>-- Selecione o Modelo --</option>';
                modelos.forEach(modelo => {
                    const opt = document.createElement('option');
                    opt.value = modelo;
                    opt.text = modelo;
                    selModelo.appendChild(opt);
                });
                selModelo.disabled = false;
            } catch (err) {
                console.error(err);
                alert("Erro ao carregar modelos.");
            }
        });
    </script>
</body>
</html>